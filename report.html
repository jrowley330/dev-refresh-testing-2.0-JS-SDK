<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Digital Dispo Dashboard (SDK)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#007bff; --overlay:rgba(0,0,0,.6); --card:#111; --text:#fff; --bar:#00bcd4; --bg:#0b0b0b; }
    html,body { margin:0; height:100%; background:#111; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    #host { height:100vh; }
    .refresh-btn { position:fixed; right:20px; bottom:20px; background:var(--brand); color:#fff; border:0; border-radius:999px; padding:14px 18px; font-size:16px; cursor:pointer; z-index:1000; box-shadow:0 8px 24px rgba(0,0,0,.2); }
    .refresh-btn:disabled { opacity:.6; cursor:not-allowed; }
    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:var(--overlay); z-index:999; }
    .overlay.active { display:flex; }
    .card { width:min(520px,92vw); background:var(--card); color:var(--text); border-radius:14px; padding:24px; box-shadow:0 12px 40px rgba(0,0,0,.35); text-align:center; }
    .progress-wrap { width:100%; background:#222; border-radius:10px; overflow:hidden; height:12px; }
    .progress-bar { width:0%; height:100%; background:var(--bar); transition:width .25s linear; }
    .eta { margin-top:10px; font-size:13px; color:#cfcfcf; }
  </style>

  <!-- Power BI JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.23.1/dist/powerbi.js"></script>
  <!-- MSAL served locally (you uploaded this to /vendor) -->
  <script src="./vendor/msal-browser.min.js"></script>
</head>

<body>
  <div id="host"></div>

  <button id="refreshBtn" class="refresh-btn">Refresh data</button>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="card">
      <h2>Refreshing your report…</h2>
      <p>We’ll reload and return you to the same page.</p>
      <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
      <div id="eta" class="eta">~30s remaining</div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const TENANT_ID = "d1c56a60-dcf2-4ba0-8d19-e41646e6ead8";
    const CLIENT_ID = "1ebcdc37-1524-4f55-ba28-38f69dc8a097";
    const REPORT_ID = "8160e2db-de87-4526-8b8e-c488f10d8b89";
    const GROUP_ID = "43b12f71-b226-42d8-80dd-d53836451585";
    const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/vchvhpyeukqgd5tyl6o3r1wf6cstb4j8";
    const REFRESH_DURATION_MS = 30000;

    const EMBED_URL = `https://app.powerbi.com/reportEmbed?reportId=${REPORT_ID}&groupId=${GROUP_ID}&ctid=${TENANT_ID}&navContentPaneEnabled=false&filterPaneEnabled=false`;


    // ===== MSAL (v3 requires initialize() first) =====
    const msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: CLIENT_ID,
        authority: `https://login.microsoftonline.com/${TENANT_ID}`,
        redirectUri: "https://jrowley330.github.io/dev-refresh-testing-2.0-JS-SDK/report"
      },
      cache: { cacheLocation: "localStorage" },
      system: { navigateToLoginRequestUrl: false }
    });
    const pbiScope = { scopes: ["https://analysis.windows.net/powerbi/api/.default"] };

    async function initMsal() {
      // v3 requirement
      await msalInstance.initialize();

      // handle redirect responses (if popup blocked we fall back to redirect)
      const redirectResp = await msalInstance.handleRedirectPromise().catch(() => {});
      if (redirectResp?.account) msalInstance.setActiveAccount(redirectResp.account);
    }

    async function getAccessToken() {
      await initMsal();

      let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

      if (account) {
        try {
          const silent = await msalInstance.acquireTokenSilent({ ...pbiScope, account });
          return silent.accessToken;
        } catch { /* fall through to interactive */ }
      }

      try {
        await msalInstance.loginPopup({ scopes: pbiScope.scopes });
      } catch {
        // popup blocked → redirect flow
        await msalInstance.loginRedirect({ scopes: pbiScope.scopes });
        return new Promise(() => {}); // stop here; page will reload to redirect URI
      }

      account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
      const res = await msalInstance.acquireTokenSilent({ ...pbiScope, account });
      return res.accessToken;
    }

    // ===== Power BI embedding =====
    let report;
    async function embedReport() {
      const accessToken = await getAccessToken();
      const models = window['powerbi-client'].models;
      const host = document.getElementById('host');

      powerbi.reset(host);

      const config = {
        type: 'report',
        tokenType: models.TokenType.Aad,
        accessToken,
        embedUrl: EMBED_URL,
        id: REPORT_ID,
        settings: {
          panes: { filters: { visible: false }, pageNavigation: { visible: true } },
          navContentPaneEnabled: false
        }
      };

      report = powerbi.embed(host, config);
      report.on('error', e => console.error('PBI error:', e.detail));
      await report.loaded;
    }

    // ===== Overlay + refresh flow =====
    const refreshBtn  = document.getElementById('refreshBtn');
    const overlay     = document.getElementById('overlay');
    const progressBar = document.getElementById('progressBar');
    const etaEl       = document.getElementById('eta');

    function showOverlay(){ overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); }
    function hideOverlay(){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); }
    function animateProgress(ms){
      progressBar.style.width='0%';
      const start = performance.now();
      return new Promise(resolve=>{
        const tick = now=>{
          const pct = Math.min(100, (now-start)/ms*100);
          progressBar.style.width = pct.toFixed(2)+'%';
          etaEl.textContent = `~${Math.max(0, Math.ceil((ms-(now-start))/1000))}s remaining`;
          pct>=100 ? resolve() : requestAnimationFrame(tick);
        }; requestAnimationFrame(tick);
      });
    }

    function triggerMake(){
      fetch(MAKE_WEBHOOK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({source:'digital-dispo-report',action:'refresh_request',ts:Date.now()})
      }).catch(()=>{});
    }

   async function refreshAndStayOnSamePage() {
  // helpers
  const waitRendered = () => new Promise(res => {
    const h = () => { report.off('rendered', h); res(); };
    report.on('rendered', h);
  });
  const withTimeout = (p, ms) =>
    Promise.race([p, new Promise((_, rej)=> setTimeout(()=>rej(new Error('timeout')), ms))]);

  try {
    refreshBtn.disabled = true;
    showOverlay();

    // start progress immediately so UI never "freezes"
    const progressP = animateProgress(REFRESH_DURATION_MS);

    // best-effort remember the page (don’t block if not ready)
    let pageName = null, pageDisplayName = null;
    try {
      const active = await withTimeout(report.getActivePage(), 1500);
      pageName = active?.name; pageDisplayName = active?.displayName;
    } catch {}

    // ---- try a cheap in-place data refresh (no auth round-trip) ----
    let refreshed = false;
    try {
      await withTimeout(report.refresh(), 15000); // refresh visuals
      await withTimeout(waitRendered(), 10000);
      refreshed = true;
    } catch (e) {
      console.warn('report.refresh() failed or timed out, falling back to reload:', e);
    }

    // ---- fallback: reload with a fresh token ----
    if (!refreshed) {
      try {
        const newToken = await withTimeout(getAccessToken(), 15000);
        await withTimeout(report.setAccessToken(newToken), 8000);
        await withTimeout(report.reload(), 15000);
        await withTimeout(waitRendered(), 10000);
      } catch (e) {
        console.error('reload path failed:', e);
      }
    }

    // restore page if we captured it
    if (pageName || pageDisplayName) {
      try {
        const pages = await withTimeout(report.getPages(), 4000);
        const target = pages.find(p => p.name === pageName) ||
                       pages.find(p => p.displayName === pageDisplayName);
        if (target) await withTimeout(target.setActive(), 4000);
      } catch {}
    }

    // wait for the progress to finish (if it already finished, resolves instantly)
    await progressP;

  } catch (e) {
    console.error('Refresh flow error:', e);
  } finally {
    // ALWAYS close overlay
    setTimeout(() => { hideOverlay(); refreshBtn.disabled = false; }, 400);
  }
}

refreshBtn.addEventListener('click', refreshAndStayOnSamePage);
    
    // bootstrap
    embedReport().catch(err => {
      console.error('Embed failed:', err);
      alert('Power BI embed failed. Check console and Azure AD app settings.');
    });
  </script>
</body>
</html>


